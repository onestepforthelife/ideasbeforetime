name: Auto-Push Improvements & Error Fixes

on:
  # Trigger when Kiro makes improvements
  workflow_dispatch:
    inputs:
      change_type:
        description: 'Type of change'
        required: true
        default: 'improvement'
        type: choice
        options:
          - improvement
          - error_fix
          - optimization
          - documentation
      description:
        description: 'Description of changes'
        required: true
        type: string

  # Also trigger on push to detect changes
  push:
    branches:
      - main
    paths:
      - '**.html'
      - '**.css'
      - '**.js'
      - '**.md'
      - '**.txt'

jobs:
  auto-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "Kiro AI Assistant"
          git config --global user.email "kiro@ideasbeforetime.com"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet HEAD; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # Get change type and description
          CHANGE_TYPE="${{ github.event.inputs.change_type || 'auto' }}"
          DESCRIPTION="${{ github.event.inputs.description || 'Automated improvements and fixes' }}"
          
          # Create commit message
          COMMIT_MSG="ðŸ¤– Auto: ${CHANGE_TYPE} - ${DESCRIPTION}"
          
          # Add all changes
          git add .
          
          # Commit with detailed message
          git commit -m "${COMMIT_MSG}" -m "
          Changes made by Kiro AI Assistant
          
          Type: ${CHANGE_TYPE}
          Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          Automated deployment to Cloudflare Pages
          "
          
          # Push to GitHub
          git push origin main

      - name: Trigger Cloudflare Deployment
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "âœ… Changes pushed to GitHub"
          echo "â³ Cloudflare Pages will auto-deploy in 2-5 minutes"
          echo "ðŸ”„ Remember to purge cache after deployment!"

      - name: Create Deployment Summary
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "## ðŸš€ Auto-Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ github.event.inputs.change_type || 'auto' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Description:** ${{ github.event.inputs.description || 'Automated improvements' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. â³ Wait 2-5 minutes for Cloudflare deployment" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ”„ Purge Cloudflare cache" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… Verify on live site" >> $GITHUB_STEP_SUMMARY

      - name: No Changes Detected
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ No changes to push"
          echo "## â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
          echo "No changes detected in the repository." >> $GITHUB_STEP_SUMMARY
